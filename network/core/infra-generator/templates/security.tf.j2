{% for nacl in nacls %}
# Network ACL for {{ nacl.name }}
resource "aws_network_acl" "{{ nacl.name }}" {
  vpc_id = aws_vpc.main.id
  tags   = merge(var.global_tags, { Name = "{{ nacl.name }}" })
}

# Ingress rules
{% if nacl.rules.ingress is defined %}
  {% for rule in nacl.rules.ingress %}
resource "aws_network_acl_rule" "{{ nacl.name }}-ingress-{{ rule.rule_number }}" {
  network_acl_id = aws_network_acl.{{ nacl.name }}.id
  rule_number    = {{ rule.rule_number }}
  protocol       = "{{ rule.protocol }}"
  rule_action    = "{{ rule.action }}"
  egress         = false
  {% if rule.protocol != "-1" %}
  from_port      = {{ rule.from_port }}
  to_port        = {{ rule.to_port }}
  {% endif %}
  cidr_block     = "{{ ALLOWED_PUBLIC_IP if rule.cidr_block == 'ALLOWED_PUBLIC_IP' else rule.cidr_block }}"
}
  {% endfor %}
{% endif %}

# Egress rules
{% if nacl.rules.egress is defined %}
  {% for rule in nacl.rules.egress %}
resource "aws_network_acl_rule" "{{ nacl.name }}-egress-{{ rule.rule_number }}" {
  network_acl_id = aws_network_acl.{{ nacl.name }}.id
  rule_number    = {{ rule.rule_number }}
  protocol       = "{{ rule.protocol }}"
  rule_action    = "{{ rule.action }}"
  egress         = true
  {% if rule.protocol != "-1" %}
  from_port      = {{ rule.from_port }}
  to_port        = {{ rule.to_port }}
  {% endif %}
  cidr_block     = "{{ rule.cidr_block }}"
}
  {% endfor %}
{% endif %}

# Associate NACL to subnet
resource "aws_network_acl_association" "{{ nacl.name }}-assoc" {
  subnet_id      = aws_subnet.{{ nacl.subnet }}.id
  network_acl_id = aws_network_acl.{{ nacl.name }}.id
}
{% endfor %}

############################################
# Security Groups
############################################

{% for sg in security_groups %}
resource "aws_security_group" "{{ sg.name | replace('-', '_') }}" {
  name        = "{{ sg.name }}"
  description = "{{ sg.description }}"
  vpc_id      = aws_vpc.main.id

  tags   = merge(var.global_tags, { Name = "{{ sg.name }}" })
}
{% endfor %}

{% for sg in security_groups %}
{% for rule in sg.ingress %}
resource "aws_security_group_rule" "{{ sg.name | replace('-', '_') }}_ingress_{{ loop.index }}" {
  type              = "ingress"
  security_group_id = aws_security_group.{{ sg.name | replace('-', '_') }}.id

  protocol  = "{{ rule.protocol }}"
  from_port = {{ rule.from_port }}
  to_port   = {{ rule.to_port }}

  {% if rule.cidr_blocks is defined %}
  cidr_blocks = [
    {% for cidr in rule.cidr_blocks %}
    "{{ ALLOWED_PUBLIC_IP if cidr == 'ALLOWED_PUBLIC_IP' else cidr }}",
    {% endfor %}
  ]
  {% endif %}

  {% if rule.source_security_groups is defined %}
  source_security_group_id = aws_security_group.{{ rule.source_security_groups[0] | replace('-', '_') }}.id
  {% endif %}
}
{% endfor %}
{% endfor %}

{% for sg in security_groups %}
{% for rule in sg.egress %}
resource "aws_security_group_rule" "{{ sg.name | replace('-', '_') }}_egress_{{ loop.index }}" {
  type              = "egress"
  security_group_id = aws_security_group.{{ sg.name | replace('-', '_') }}.id

  protocol  = "{{ rule.protocol }}"
  from_port = {{ rule.from_port }}
  to_port   = {{ rule.to_port }}

  cidr_blocks = [
    {% for cidr in rule.cidr_blocks %}
    "{{ cidr }}",
    {% endfor %}
  ]
}
{% endfor %}
{% endfor %}
